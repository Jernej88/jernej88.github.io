<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="sl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PostgreSQL and faster trigram similarity search | Jernej Zupančič blog</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (sl)" href="../../rss.xml">
<link rel="canonical" href="https://jernejzupancic.si/sl/posts/postgresql-and-faster-trigram-similarity-search/">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
<meta name="author" content="Jernej Zupančič">
<link rel="prev" href="../mysterious-nginx-upstream-errors/" title="Mysterious nginx upstream errors" type="text/html">
<link rel="next" href="../pytest-coverage-reports-and-gitlab-runners/" title="PyTest, coverage reports and Gitlab runners" type="text/html">
<meta property="og:site_name" content="Jernej Zupančič blog">
<meta property="og:title" content="PostgreSQL and faster trigram similarity search">
<meta property="og:url" content="https://jernejzupancic.si/sl/posts/postgresql-and-faster-trigram-similarity-search/">
<meta property="og:description" content="Awesome PostgreSQL claims to be the world's most advanced open source relational database. Considering what it can do, it probably really is. Today I want to write about a text search functionality it">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-02-12T22:08:24+01:00">
<meta property="article:tag" content="postgres">
<meta property="article:tag" content="postgresql">
<meta property="article:tag" content="search">
<meta property="article:tag" content="trigrams">
<link rel="alternate" hreflang="en" href="../../../posts/postgresql-and-faster-trigram-similarity-search/">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Preskoči na glavno vsebino</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://jernejzupancic.si/sl/">

            <span id="blog-title">Jernej Zupančič blog</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../blog/" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Arhiv</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Značke</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">vir RSS</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li>
            </li>
<li class="nav-item"><a href="https://jernejzupancic.si/" rel="alternate" hreflang="en" class="nav-link">English</a></li>

                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">PostgreSQL and faster trigram similarity search</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Jernej Zupančič
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-02-12T22:08:24+01:00" itemprop="datePublished" title="2020-02-12 22:08">2020-02-12 22:08</time></a>
            </p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/postgresql-and-faster-trigram-similarity-search.html">Komentarji</a>


            

        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Awesome <a href="https://www.postgresql.org/">PostgreSQL</a> claims to be the world's most advanced open source relational database. Considering what it can do, it probably really is. Today I want to write about a text search functionality it supports through the <a href="https://www.postgresql.org/docs/12/pgtrgm.html"><strong>pg_trgm</strong></a> module.
<!-- TEASER_END --></p>
<h2>pg_trgm</h2>
<p>This is a module that already comes with the PostgreSQL database itself. As stated in the documentation:</p>
<blockquote>
<p>The pg_trgm module provides functions and operators for determining the similarity of alphanumeric text based on trigram matching, as well as index operator classes that support fast searching for similar strings.</p>
<p>(<a href="https://www.postgresql.org/docs/12/pgtrgm.html">source</a>)</p>
</blockquote>
<p>A trigram is a substring of three consecutive characters in a string. The <em>pg_trgm</em> module only takes into accout alphanumeric characters and padds each word with two empty spaces at the beginning and one empty space at the end. Therefore, trigrams of the <code>word</code> are computed as <code>__w</code>, <code>_wo</code>, <code>wor</code>, <code>ord</code>, <code>rd_</code>, where <code>_</code> represents one empty space.</p>
<h2>The problem</h2>
<p>In one of the applications we are developing, we are given a text document and need to find similar documents in the database. In the year 2020 this calls for document to vector embedding methods and that is precisely what we plan to do. However, for the initial prototype, we thought that trigram similarity offered by the PostgreSQL would suffice. So one of our developers did a quick search on how this could be done. Store the document as text and setup the GIN index with the trigram ops. Something like:</p>
<pre class="code literal-block"><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">documents</span> <span class="p">(</span><span class="n">original_id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">searchable_text</span> <span class="nb">text</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">trgm_idx</span> <span class="k">ON</span> <span class="n">documents</span> <span class="k">USING</span> <span class="n">GIN</span> <span class="p">(</span><span class="n">searchable_text</span> <span class="n">gin_trgm_ops</span><span class="p">);</span>
</pre>


<p>And for the query, he came up with something like the following:</p>
<pre class="code literal-block"><span></span><span class="k">WITH</span> <span class="n">current_document</span> <span class="k">AS</span>
<span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">searchable_text</span>
    <span class="k">FROM</span> <span class="n">documents</span>
    <span class="k">WHERE</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="o">=</span> <span class="mi">94594</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="k">AS</span> <span class="n">original_id</span>
<span class="k">FROM</span> 
    <span class="n">documents</span><span class="p">,</span> <span class="n">current_document</span>
<span class="k">WHERE</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">&lt;&gt;</span> <span class="s1">''</span> 
    <span class="k">AND</span> <span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="k">GROUP</span> <span class="k">BY</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span><span class="p">,</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span>
    <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">)</span> <span class="k">DESC</span><span class="p">;</span>
</pre>


<h2>Improving the search query</h2>
<p>This, however, had a problem of too long execution time in the range of one minute. Since this call was meant to be used online, it was clearly taking too long. In our application each document text is quite large, in the range of few thousands of characters, which obviously impacts the execution time. So I went about optimizing the query using obvious improvements:</p>
<ol>
<li>Adding <code>similarity</code> score to the <code>SELECT</code>, since this is what will be needed by the application in next steps.</li>
<li>Dropping the <code>GROUP BY</code>, since it makes no sense.</li>
<li>Dropping the <code>IS NOT NULL</code> condition in <code>WHERE</code>, since already computed similarity cannot be used in the <code>WHERE</code> clause. Only existing columns and not computed ones can be used in the <code>WHERE</code> clause.</li>
<li>Ordering is done by the computed similarity.</li>
</ol>
<p>So I came up with the following statements (also using the <code>EXPLAIN ANALYZE</code> to see what is happening and where the time is spent):</p>
<pre class="code literal-block"><span></span><span class="k">EXPLAIN</span> <span class="k">ANALYZE</span> <span class="k">WITH</span> <span class="n">current_document</span> <span class="k">AS</span>
<span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">searchable_text</span>
    <span class="k">FROM</span> <span class="n">documents</span>
    <span class="k">WHERE</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="o">=</span> <span class="mi">94594</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="k">AS</span> <span class="n">original_id</span><span class="p">,</span> <span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sml</span>
<span class="k">FROM</span> 
    <span class="n">documents</span><span class="p">,</span> <span class="n">current_document</span>
<span class="k">WHERE</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">&lt;&gt;</span> <span class="s1">''</span> 
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">sml</span> <span class="k">DESC</span><span class="p">;</span> 

<span class="k">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">2933</span><span class="p">.</span><span class="mi">46</span><span class="p">..</span><span class="mi">2933</span><span class="p">.</span><span class="mi">47</span> <span class="k">rows</span><span class="o">=</span><span class="mi">5</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">31699</span><span class="p">.</span><span class="mi">637</span><span class="p">..</span><span class="mi">31699</span><span class="p">.</span><span class="mi">648</span> <span class="k">rows</span><span class="o">=</span><span class="mi">5</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="n">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">2933</span><span class="p">.</span><span class="mi">46</span><span class="p">..</span><span class="mi">2983</span><span class="p">.</span><span class="mi">03</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19829</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">31699</span><span class="p">.</span><span class="mi">633</span><span class="p">..</span><span class="mi">31699</span><span class="p">.</span><span class="mi">636</span> <span class="k">rows</span><span class="o">=</span><span class="mi">5</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="n">Sort</span> <span class="k">Key</span><span class="p">:</span> <span class="p">(</span><span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">documents_1</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">))</span> <span class="k">DESC</span>
         <span class="n">Sort</span> <span class="k">Method</span><span class="p">:</span> <span class="n">top</span><span class="o">-</span><span class="n">N</span> <span class="n">heapsort</span>  <span class="n">Memory</span><span class="p">:</span> <span class="mi">25</span><span class="n">kB</span>
         <span class="o">-&gt;</span>  <span class="n">Nested</span> <span class="n">Loop</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">2604</span><span class="p">.</span><span class="mi">11</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19829</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">.</span><span class="mi">304</span><span class="p">..</span><span class="mi">31676</span><span class="p">.</span><span class="mi">653</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19784</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">-&gt;</span>  <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="n">documents_original_id_key</span> <span class="k">on</span> <span class="n">documents</span> <span class="n">documents_1</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">31</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">104</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">134</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">138</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                     <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">original_id</span> <span class="o">=</span> <span class="mi">94594</span><span class="p">)</span>
               <span class="o">-&gt;</span>  <span class="n">Seq</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">documents</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">2347</span><span class="p">.</span><span class="mi">94</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19829</span> <span class="n">width</span><span class="o">=</span><span class="mi">108</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">020</span><span class="p">..</span><span class="mi">38</span><span class="p">.</span><span class="mi">786</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19784</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">Filter</span><span class="p">:</span> <span class="p">(</span><span class="n">searchable_text</span> <span class="o">&lt;&gt;</span> <span class="s1">''</span><span class="p">::</span><span class="nb">text</span><span class="p">)</span>
                     <span class="k">Rows</span> <span class="n">Removed</span> <span class="k">by</span> <span class="n">Filter</span><span class="p">:</span> <span class="mi">17037</span>
 <span class="n">Planning</span> <span class="n">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">272</span> <span class="n">ms</span>
 <span class="n">Execution</span> <span class="n">Time</span><span class="p">:</span> <span class="mi">31699</span><span class="p">.</span><span class="mi">717</span> <span class="n">ms</span>
</pre>


<p>So the execution time was cut in half for this particular example (and others too). However, the GIN index is not used. After some research I found out why:</p>
<blockquote>
<p>PostgreSQL doesn't use indexed for functions, it only uses them for operators.</p>
<p><em><a href="https://stackoverflow.com/a/28546686">source</a></em></p>
</blockquote>
<p>Since <code>similarity</code> is a function, there is no index use. Scanning through the documentation I see that <code>%</code> operator is used for similarity testing. Therefore, by limiting the search results only to the similar documents, as returned by the <code>%</code> operator, the query should perform better.</p>
<pre class="code literal-block"><span></span><span class="k">EXPLAIN</span> <span class="k">ANALYZE</span> <span class="k">WITH</span> <span class="n">current_document</span> <span class="k">AS</span>
<span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">searchable_text</span>
    <span class="k">FROM</span> <span class="n">documents</span>
    <span class="k">WHERE</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="o">=</span> <span class="mi">94594</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="k">AS</span> <span class="n">original_id</span><span class="p">,</span> <span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sml</span>
<span class="k">FROM</span> 
    <span class="n">documents</span><span class="p">,</span> <span class="n">current_document</span>
<span class="k">WHERE</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">&lt;&gt;</span> <span class="s1">''</span> 
    <span class="k">AND</span> <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">%</span> <span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">sml</span> 
    <span class="k">DESC</span><span class="p">;</span>

 <span class="k">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1948</span><span class="p">.</span><span class="mi">82</span><span class="p">..</span><span class="mi">1948</span><span class="p">.</span><span class="mi">83</span> <span class="k">rows</span><span class="o">=</span><span class="mi">5</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">62594</span><span class="p">.</span><span class="mi">384</span><span class="p">..</span><span class="mi">62594</span><span class="p">.</span><span class="mi">396</span> <span class="k">rows</span><span class="o">=</span><span class="mi">5</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="n">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1948</span><span class="p">.</span><span class="mi">82</span><span class="p">..</span><span class="mi">1948</span><span class="p">.</span><span class="mi">87</span> <span class="k">rows</span><span class="o">=</span><span class="mi">20</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">62594</span><span class="p">.</span><span class="mi">381</span><span class="p">..</span><span class="mi">62594</span><span class="p">.</span><span class="mi">384</span> <span class="k">rows</span><span class="o">=</span><span class="mi">5</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="n">Sort</span> <span class="k">Key</span><span class="p">:</span> <span class="p">(</span><span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">documents_1</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">))</span> <span class="k">DESC</span>
         <span class="n">Sort</span> <span class="k">Method</span><span class="p">:</span> <span class="n">top</span><span class="o">-</span><span class="n">N</span> <span class="n">heapsort</span>  <span class="n">Memory</span><span class="p">:</span> <span class="mi">25</span><span class="n">kB</span>
         <span class="o">-&gt;</span>  <span class="n">Nested</span> <span class="n">Loop</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1800</span><span class="p">.</span><span class="mi">59</span><span class="p">..</span><span class="mi">1948</span><span class="p">.</span><span class="mi">49</span> <span class="k">rows</span><span class="o">=</span><span class="mi">20</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">822</span><span class="p">.</span><span class="mi">798</span><span class="p">..</span><span class="mi">62568</span><span class="p">.</span><span class="mi">580</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19146</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">-&gt;</span>  <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="n">documents_original_id_key</span> <span class="k">on</span> <span class="n">documents</span> <span class="n">documents_1</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">31</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">104</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">057</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">061</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                     <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">original_id</span> <span class="o">=</span> <span class="mi">94594</span><span class="p">)</span>
               <span class="o">-&gt;</span>  <span class="n">Bitmap</span> <span class="n">Heap</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">documents</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1800</span><span class="p">.</span><span class="mi">30</span><span class="p">..</span><span class="mi">1939</span><span class="p">.</span><span class="mi">93</span> <span class="k">rows</span><span class="o">=</span><span class="mi">20</span> <span class="n">width</span><span class="o">=</span><span class="mi">108</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">821</span><span class="p">.</span><span class="mi">842</span><span class="p">..</span><span class="mi">32317</span><span class="p">.</span><span class="mi">506</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19146</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">Filter</span><span class="p">:</span> <span class="p">((</span><span class="n">searchable_text</span> <span class="o">&lt;&gt;</span> <span class="s1">''</span><span class="p">::</span><span class="nb">text</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">documents_1</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">%</span> <span class="n">searchable_text</span><span class="p">))</span>
                     <span class="k">Rows</span> <span class="n">Removed</span> <span class="k">by</span> <span class="n">Filter</span><span class="p">:</span> <span class="mi">584</span>
                     <span class="n">Heap</span> <span class="n">Blocks</span><span class="p">:</span> <span class="n">exact</span><span class="o">=</span><span class="mi">1822</span>
                     <span class="o">-&gt;</span>  <span class="n">Bitmap</span> <span class="k">Index</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">index_trgm_searchable_text</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">1800</span><span class="p">.</span><span class="mi">29</span> <span class="k">rows</span><span class="o">=</span><span class="mi">39</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">820</span><span class="p">.</span><span class="mi">627</span><span class="p">..</span><span class="mi">820</span><span class="p">.</span><span class="mi">627</span> <span class="k">rows</span><span class="o">=</span><span class="mi">19734</span> <span class="n">loops</span><span class="o">=</span>
<span class="mi">1</span><span class="p">)</span>
                           <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">searchable_text</span> <span class="o">%</span> <span class="n">documents_1</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">)</span>
 <span class="n">Planning</span> <span class="n">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">346</span> <span class="n">ms</span>
 <span class="n">Execution</span> <span class="n">Time</span><span class="p">:</span> <span class="mi">62596</span><span class="p">.</span><span class="mi">338</span> <span class="n">ms</span>
</pre>


<p>Now, index is used, however, the execution time has again spiked to a minute. Going through the output, it seems that the similarity operator does not filter out many rows. I assume that because our documents are so long, they are also quite similar with respect to the trigram similarity. After consulting the documentation, I see that <code>pg_trgm.similarity_threshold</code> GUC parameter can be increased to limit the similar results. After some trial I finally set on the following:</p>
<pre class="code literal-block"><span></span><span class="k">SET</span> <span class="n">pg_trgm</span><span class="p">.</span><span class="n">similarity_threshold</span> <span class="k">TO</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">;</span>
<span class="k">EXPLAIN</span> <span class="k">ANALYZE</span> <span class="k">WITH</span> <span class="n">current_document</span> <span class="k">AS</span>
<span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">searchable_text</span>
    <span class="k">FROM</span> <span class="n">documents</span>
    <span class="k">WHERE</span> <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="o">=</span> <span class="mi">94594</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">original_id</span> <span class="k">AS</span> <span class="n">original_id</span><span class="p">,</span> <span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sml</span>
<span class="k">FROM</span> 
    <span class="n">documents</span><span class="p">,</span> <span class="n">current_document</span>
<span class="k">WHERE</span> 
    <span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">&lt;&gt;</span> <span class="s1">''</span> 
    <span class="k">AND</span> <span class="n">current_document</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">%</span> <span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">sml</span> <span class="k">DESC</span><span class="p">;</span>

 <span class="k">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1948</span><span class="p">.</span><span class="mi">82</span><span class="p">..</span><span class="mi">1948</span><span class="p">.</span><span class="mi">83</span> <span class="k">rows</span><span class="o">=</span><span class="mi">5</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">15327</span><span class="p">.</span><span class="mi">644</span><span class="p">..</span><span class="mi">15327</span><span class="p">.</span><span class="mi">650</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="n">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1948</span><span class="p">.</span><span class="mi">82</span><span class="p">..</span><span class="mi">1948</span><span class="p">.</span><span class="mi">87</span> <span class="k">rows</span><span class="o">=</span><span class="mi">20</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">15327</span><span class="p">.</span><span class="mi">640</span><span class="p">..</span><span class="mi">15327</span><span class="p">.</span><span class="mi">642</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="n">Sort</span> <span class="k">Key</span><span class="p">:</span> <span class="p">(</span><span class="n">similarity</span><span class="p">(</span><span class="n">documents</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">,</span> <span class="n">documents_1</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">))</span> <span class="k">DESC</span>
         <span class="n">Sort</span> <span class="k">Method</span><span class="p">:</span> <span class="n">quicksort</span>  <span class="n">Memory</span><span class="p">:</span> <span class="mi">25</span><span class="n">kB</span>
         <span class="o">-&gt;</span>  <span class="n">Nested</span> <span class="n">Loop</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1800</span><span class="p">.</span><span class="mi">59</span><span class="p">..</span><span class="mi">1948</span><span class="p">.</span><span class="mi">49</span> <span class="k">rows</span><span class="o">=</span><span class="mi">20</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">1425</span><span class="p">.</span><span class="mi">643</span><span class="p">..</span><span class="mi">15327</span><span class="p">.</span><span class="mi">608</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">-&gt;</span>  <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="n">documents_original_id_key</span> <span class="k">on</span> <span class="n">documents</span> <span class="n">documents_1</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">31</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">104</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">055</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">060</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                     <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">original_id</span> <span class="o">=</span> <span class="mi">94594</span><span class="p">)</span>
               <span class="o">-&gt;</span>  <span class="n">Bitmap</span> <span class="n">Heap</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">documents</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1800</span><span class="p">.</span><span class="mi">30</span><span class="p">..</span><span class="mi">1939</span><span class="p">.</span><span class="mi">93</span> <span class="k">rows</span><span class="o">=</span><span class="mi">20</span> <span class="n">width</span><span class="o">=</span><span class="mi">108</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">1424</span><span class="p">.</span><span class="mi">625</span><span class="p">..</span><span class="mi">15323</span><span class="p">.</span><span class="mi">821</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                     <span class="n">Filter</span><span class="p">:</span> <span class="p">((</span><span class="n">searchable_text</span> <span class="o">&lt;&gt;</span> <span class="s1">''</span><span class="p">::</span><span class="nb">text</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">documents_1</span><span class="p">.</span><span class="n">searchable_text</span> <span class="o">%</span> <span class="n">searchable_text</span><span class="p">))</span>
                     <span class="k">Rows</span> <span class="n">Removed</span> <span class="k">by</span> <span class="n">Filter</span><span class="p">:</span> <span class="mi">6372</span>
                     <span class="n">Heap</span> <span class="n">Blocks</span><span class="p">:</span> <span class="n">exact</span><span class="o">=</span><span class="mi">1739</span>
                     <span class="o">-&gt;</span>  <span class="n">Bitmap</span> <span class="k">Index</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">index_trgm_searchable_text</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">1800</span><span class="p">.</span><span class="mi">29</span> <span class="k">rows</span><span class="o">=</span><span class="mi">39</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">820</span><span class="p">.</span><span class="mi">814</span><span class="p">..</span><span class="mi">820</span><span class="p">.</span><span class="mi">814</span> <span class="k">rows</span><span class="o">=</span><span class="mi">6379</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
                           <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">searchable_text</span> <span class="o">%</span> <span class="n">documents_1</span><span class="p">.</span><span class="n">searchable_text</span><span class="p">)</span>
 <span class="n">Planning</span> <span class="n">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">410</span> <span class="n">ms</span>
 <span class="n">Execution</span> <span class="n">Time</span><span class="p">:</span> <span class="mi">15329</span><span class="p">.</span><span class="mi">717</span> <span class="n">ms</span>
</pre>


<p>So, 15 seconds execution time. Since this is not our final solution, I will leave it be. To speed things up, I will set-up caching on the application side. Since the documents do not change or update very frequently, caching with 10 minutes time-to-live, should be OK.</p>
<p>I have also tried using GIST index, however, the creation of index fails, because our text is too large:</p>
<pre class="code literal-block"><span></span><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">index_trgm_searchable_text</span> <span class="k">ON</span> <span class="n">documents</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">searchable_text</span> <span class="n">gist_trgm_ops</span><span class="p">);</span>
<span class="n">ERROR</span><span class="p">:</span>  <span class="k">index</span> <span class="k">row</span> <span class="n">requires</span> <span class="mi">12256</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">maximum</span> <span class="k">size</span> <span class="k">is</span> <span class="mi">8191</span>
</pre>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/postgres/" rel="tag">postgres</a></li>
            <li><a class="tag p-category" href="../../categories/postgresql/" rel="tag">postgresql</a></li>
            <li><a class="tag p-category" href="../../categories/search/" rel="tag">search</a></li>
            <li><a class="tag p-category" href="../../categories/trigrams/" rel="tag">trigrams</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../mysterious-nginx-upstream-errors/" rel="prev" title="Mysterious nginx upstream errors">Prejšnja objava</a>
            </li>
            <li class="next">
                <a href="../pytest-coverage-reports-and-gitlab-runners/" rel="next" title="PyTest, coverage reports and Gitlab runners">Naslednja objava</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Komentarji</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="jernejzupancic",
            disqus_url="https://jernejzupancic.si/sl/posts/postgresql-and-faster-trigram-similarity-search/",
        disqus_title="PostgreSQL and faster trigram similarity search",
        disqus_identifier="cache/posts/postgresql-and-faster-trigram-similarity-search.html",
        disqus_config = function () {
            this.language = "sl";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="jernejzupancic";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer"><div class="text-center">
<p>
<span class="fa-stack fa-2x">
<a href="https://github.com/Jernej88">
    <i class="fa fa-circle fa-stack-2x"></i>
    <i class="fa fa-github fa-inverse fa-stack-1x"></i>
</a>
</span>
</p>
</div>
Contents © 2020         <a href="mailto:jernej@jernejzupancic.si">Jernej Zupančič</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
 <img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>

            
            
        </footer>
</div>
</div>


        <script src="../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
