<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="sl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mysterious nginx upstream errors | Jernej Zupančič blog</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (sl)" href="../../rss.xml">
<link rel="canonical" href="https://jernejzupancic.si/sl/posts/mysterious-nginx-upstream-errors/">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
<meta name="author" content="Jernej Zupančič">
<link rel="prev" href="../python-and-tricky-function-arguments/" title="Python and tricky function arguments" type="text/html">
<meta property="og:site_name" content="Jernej Zupančič blog">
<meta property="og:title" content="Mysterious nginx upstream errors">
<meta property="og:url" content="https://jernejzupancic.si/sl/posts/mysterious-nginx-upstream-errors/">
<meta property="og:description" content="For easier web app deploy we use the following stack

Ubuntu server
Docker
Containerized Nginx proxy with Letsencrypt companion
Containerized Web app

Docker simplifies the web app development by enab">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-02-07T22:06:59+01:00">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="web">
<link rel="alternate" hreflang="en" href="../../../posts/mysterious-nginx-upstream-errors/">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Preskoči na glavno vsebino</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://jernejzupancic.si/sl/">

            <span id="blog-title">Jernej Zupančič blog</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../blog/" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Arhiv</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Značke</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">vir RSS</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li>
            </li>
<li class="nav-item"><a href="https://jernejzupancic.si/" rel="alternate" hreflang="en" class="nav-link">English</a></li>

                
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Mysterious nginx upstream errors</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Jernej Zupančič
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-02-07T22:06:59+01:00" itemprop="datePublished" title="2020-02-07 22:06">2020-02-07 22:06</time></a>
            </p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/mysterious-nginx-upstream-errors.html">Komentarji</a>


            

        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>For easier web app deploy we use the following stack</p>
<ol>
<li>Ubuntu server</li>
<li><a href="https://www.docker.com/products/container-runtime">Docker</a></li>
<li>Containerized <a href="https://github.com/jwilder/nginx-proxy">Nginx proxy</a> with <a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion">Letsencrypt companion</a>
</li>
<li>Containerized Web app</li>
</ol>
<p>Docker simplifies the web app development by enabling us, the developers, to pin the majority of the software dependencies versions, and, further, to have the exact same dependencies during development as for the deploy. This greatly reduces the "<em>it works on my machine</em>" moments. Those moments do not go away fully, because we usually do not specify the version of every last dependency used, however, they become really rare. One thing we do not test in development, though, is the web app operation when coupled with Nginx. And that sometimes leads to unexpected problems, such as the random upstream errors I will describe in next few lines.
<!-- TEASER_END --></p>
<h2>The problem</h2>
<p>When several containers were running on our machine, using the setup as described above, a strange behavior appeared. Our monitoring tool (<a href="https://uptimerobot.com/">UptimeRobot</a>, use it, it is great and has a free tier), reported that one of the web app containers keeps returning service unavailable error every few minutes. It was not always the same app container, after some time and usually after a machine restart, another app container was chosen to be problematic and there was just no deterministic way to figure out which will be hit next. The Nginx kept reporting an error that looked something like follows:</p>
<pre class="code literal-block"><span></span><span class="o">[</span><span class="n">error</span><span class="o">]</span><span class="w"> </span><span class="mi">27212</span><span class="n">#0</span><span class="err">:</span><span class="w"> </span><span class="o">*</span><span class="mi">314</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="n">upstreams</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">connecting</span><span class="w"> </span><span class="k">to</span><span class="w">   </span><span class="n">upstream</span><span class="p">,</span><span class="w"> </span><span class="nl">client</span><span class="p">:</span><span class="w"> </span><span class="n">ip_address</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nl">server</span><span class="p">:</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="w"> </span><span class="nl">request</span><span class="p">:</span><span class="w"> </span><span class="ss">"GET / HTTP/1.1"</span><span class="p">,</span><span class="w"> </span><span class="nl">upstream</span><span class="p">:</span><span class="w"> </span><span class="ss">"http://example.com"</span><span class="p">,</span><span class="w"> </span><span class="k">host</span><span class="err">:</span><span class="w"> </span><span class="ss">"example.com"</span><span class="p">,</span><span class="w"> </span><span class="nl">referrer</span><span class="p">:</span><span class="w"> </span><span class="ss">"http://example.com/mypages/"</span><span class="w"></span>
</pre>


<p>We used our Google-fu to no success. Apparently no-one else on Github issues or Stackoverflow was having those problems. We just crossed our fingers that the next container "hit" by this strange behavior won't be the one that matters and at the time when it matters, before we address the issue. And that's exactly what happened. The boss wanted an application demonstration, which we could not deliver, because the browser kept showing the 502 - Service unavailable error.</p>
<h2>Getting serious</h2>
<p>After that unfortunate demonstration I jumped at the problem with a renewed zeal. There's got to be something we can do. Changing to another proxy seemed a tempting idea and I had my eye on <a href="https://containo.us/traefik/">Traefik</a> for a while. Traefik seemed like a proxy built for the container age. But that would be our last resort, since it meant changing a bunch of things, and who can guarantee that it will work as promised. Also at the time, Traefik 2 was announced, which would mean that we will have to update everything all over again.</p>
<p>So I tried to systematically analyze our problem in order to finally find some pattern about the frequency of the error or about which container would be hit next. Since Nginx complained that there was no live upstream I <code>curl</code>ed the endpoints within the app containers to count how many times the web app from within the container would die. </p>
<h2>Lucky stumble</h2>
<p>Now guess what. None of the containerized web apps ever died and what is more, even UptimeRobot stopped reporting the 502 errors for the time of the test. So I had an idea, I will simply set-up a cron job to periodically <code>curl</code> the endpoints of every container running. The following line was born after some trial and error</p>
<pre class="code literal-block"><span></span>docker ps -q <span class="p">|</span> xargs -I<span class="o">{}</span> docker inspect <span class="o">{}</span> <span class="p">|</span> jq <span class="s1">'.[0].NetworkSettings.Networks | .[].IPAddress'</span> <span class="p">|</span> xargs -I<span class="o">{}</span> curl -I <span class="o">{}</span>
</pre>


<p>This line, together with <code>cron</code> now keeps the lights on and applications running without 502 for several months now and unless someone tells me how to solve the problem properly it will stay that way for a while. </p>
<p>It nags me that I could not find a proper solution, however:</p>
<ol>
<li>The services are not that critical</li>
<li>I am not an expert in the field</li>
<li>We ran out of time. </li>
</ol>
<p>We are now deep in new projects with new challenges and this one waits until some smarter guy or a gal comes around and fixes it.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/docker/" rel="tag">docker</a></li>
            <li><a class="tag p-category" href="../../categories/nginx/" rel="tag">nginx</a></li>
            <li><a class="tag p-category" href="../../categories/web/" rel="tag">web</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../python-and-tricky-function-arguments/" rel="prev" title="Python and tricky function arguments">Prejšnja objava</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Komentarji</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="jernejzupancic",
            disqus_url="https://jernejzupancic.si/sl/posts/mysterious-nginx-upstream-errors/",
        disqus_title="Mysterious nginx upstream errors",
        disqus_identifier="cache/posts/mysterious-nginx-upstream-errors.html",
        disqus_config = function () {
            this.language = "sl";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="jernejzupancic";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer"><div class="text-center">
<p>
<span class="fa-stack fa-2x">
<a href="https://github.com/Jernej88">
    <i class="fa fa-circle fa-stack-2x"></i>
    <i class="fa fa-github fa-inverse fa-stack-1x"></i>
</a>
</span>
</p>
</div>
Contents © 2020         <a href="mailto:jernej@jernejzupancic.si">Jernej Zupančič</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         

            
            
        </footer>
</div>
</div>


        <script src="../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
